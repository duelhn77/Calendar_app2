{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}},
    {"offset": {"line": 276, "column": 0}, "map": {"version":3,"sources":["file://C%3A/Users/hiros/OneDrive%20-%20%E6%88%90%E7%94%B0%E5%BC%98/Tech0/VS%20Code/Git_Clone_calendar_app/Calendar_app2/src/app/api/exportData/route.ts"],"sourcesContent":["import { google } from \"googleapis\";\r\nimport { NextResponse } from \"next/server\";\r\nimport { parse } from \"json2csv\";\r\nimport ExcelJS from \"exceljs\";\r\n\r\nconst SHEET_ID = process.env.SHEET_ID || \"\";\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const { startDate, endDate, format, userId } = await req.json(); // üîπ `userId` „ÇíËøΩÂä†\r\n\r\n    console.log(\"üì§ API Âèó‰ø°:\", { startDate, endDate, format, userId });\r\n\r\n    const auth = new google.auth.GoogleAuth({\r\n      credentials: {\r\n        type: \"service_account\",\r\n        project_id: process.env.GOOGLE_PROJECT_ID,\r\n        private_key: process.env.GOOGLE_PRIVATE_KEY?.replace(/\\\\n/g, \"\\n\"),\r\n        client_email: process.env.GOOGLE_CLIENT_EMAIL,\r\n      },\r\n      scopes: [\"https://www.googleapis.com/auth/spreadsheets.readonly\"],\r\n    });\r\n\r\n    const sheets = google.sheets({ version: \"v4\", auth });\r\n\r\n    // ‚úÖ „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó\r\n    const response = await sheets.spreadsheets.values.get({\r\n      spreadsheetId: SHEET_ID,\r\n      range: \"TimeSheet!A:Z\", // üîπ „Ç´„É©„É†Êï∞„ÅåÂ§âÂãï„Åó„Å¶„ÇÇÂÖ®„Å¶ÂèñÂæó\r\n    });\r\n\r\n    const rows = response.data.values || [];\r\n    console.log(\"üìä ÂèñÂæó„Éá„Éº„Çø:\", rows.length, \"‰ª∂\");\r\n\r\n    if (rows.length < 2) throw new Error(\"„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì\");\r\n\r\n\r\n    const maxColumns = Math.max(...rows.map(row => row.length)); // ÂêÑË°å„ÅÆÊúÄÂ§ßÂàóÊï∞„ÇíÂèñÂæó\r\n    const headers = [...rows[0], \"Êó•‰ªò\", \"ÊôÇÈñì\"];   // ‚úÖ „Éò„ÉÉ„ÉÄ„Éº„ÇíÊã°ÂºµÔºàKÂàó \"Êó•‰ªò\", LÂàó \"ÊôÇÈñì\" „ÇíËøΩÂä†Ôºâ\r\n    const dataRows = rows.slice(1); // üîπ ÂÆü„Éá„Éº„Çø\r\n\r\n    // üîπ „Éò„ÉÉ„ÉÄ„Éº„Åã„Çâ„Ç´„É©„É†„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÂèñÂæó\r\n    const userIdIndex = headers.indexOf(\"UserID\");\r\n    const startIndex = headers.indexOf(\"Start\");\r\n    const endIndex = headers.indexOf(\"End\");\r\n\r\n    if (userIdIndex === -1 || startIndex === -1 || endIndex === -1) {\r\n      throw new Error(\"ÂøÖË¶Å„Å™„Ç´„É©„É†„Åå„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì\");\r\n    }\r\n\r\n    // ‚úÖ „É¶„Éº„Ç∂„ÉºID„Å®ÊúüÈñì„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞\r\n    const filteredData = dataRows\r\n     .filter(row => {\r\n       const rowUserId = row[userIdIndex] || \"\"; // `UserID` „ÅÆ„Ç´„É©„É†\r\n       const rowStart = new Date(row[startIndex]); // `Start` „ÅÆ„Ç´„É©„É†\r\n       const rowEnd = new Date(row[endIndex]);   // `End` „ÅÆ„Ç´„É©„É†\r\n\r\n       const rowStartDate = rowStart.toISOString().split(\"T\")[0];\r\n       const rowEndDate = rowEnd.toISOString().split(\"T\")[0];\r\n      \r\n       const userFilter = userId ? rowUserId === userId : true; // ‚úÖ `userId` „ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Åù„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ„Åø„ÇíÊäΩÂá∫\r\n       const dateFilter = rowStartDate >= startDate && rowEndDate <= endDate;\r\n\r\n       return userFilter && dateFilter;\r\n     })\r\n     .map(row => {\r\n      const rowStart = new Date(row[startIndex]);\r\n      const rowEnd = new Date(row[endIndex]);\r\n\r\n      // üîπ KÂàóÔºà\"Êó•‰ªò\"ÔºâÔºöYYYY-MM-DD „ÅÆÂΩ¢Âºè\r\n      const formattedDate = rowStart.toISOString().split(\"T\")[0];\r\n\r\n      // üîπ LÂàóÔºà\"ÊôÇÈñì\"ÔºâÔºö15ÂàÜÂçò‰Ωç„Åß„ÅÆÊôÇÈñìË®àÁÆó\r\n      const timeDiffMinutes = (rowEnd.getTime() - rowStart.getTime()) / (1000 * 60);\r\n      const timeHours = timeDiffMinutes / 60;\r\n      const roundedTime = Math.round(timeHours * 4) / 4; // 15ÂàÜÂçò‰Ωç„Åß‰∏∏„ÇÅ„Çã\r\n\r\n\r\n       // ‚úÖ **JÂàó„ÅåÁ©∫ÁôΩ„Åß„ÇÇKÂàó„ÅåÈÅ©Âàá„Å™‰ΩçÁΩÆ„Å´ÂÖ•„Çã„Çà„ÅÜ„Å´Ë™øÊï¥**\r\n      const newRow = [...row];\r\n      newRow[maxColumns] = formattedDate; // KÂàóÔºàÊúÄÂ§ßÂàóÊï∞„ÅÆÊ¨°Ôºâ\r\n      newRow[maxColumns + 1] = roundedTime.toString(); // LÂàóÔºàÊúÄÂ§ßÂàóÊï∞+1Ôºâ\r\n\r\n      return newRow;\r\n    });\r\n\r\n    console.log(\"üìä „Éï„Ç£„É´„ÇøÂæå:\", filteredData.length, \"‰ª∂\");\r\n\r\n    if (!filteredData.length) throw new Error(\"ÊåáÂÆöÊúüÈñì„ÅÆ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì\");\r\n\r\n    let fileBuffer;\r\n    let contentType;\r\n    let fileExtension;\r\n\r\n    if (format === \"csv\") {\r\n      // ‚úÖ CSV ÂΩ¢Âºè„Åß„Ç®„ÇØ„Çπ„Éù„Éº„Éà\r\n      const formattedCsvData = filteredData.map(row => {\r\n        // `headers.length` „Å´ÊèÉ„Åà„Å¶„ÄÅ‰∏çË∂≥ÂàÜ„ÇíÁ©∫ÊñáÂ≠ó„ÅßÂüã„ÇÅ„Çã\r\n        const paddedRow = [...row, ...new Array(headers.length - row.length).fill(\"\")];\r\n        return Object.fromEntries(headers.map((header, i) => [header, paddedRow[i] ?? \"\"]));\r\n      });\r\n\r\n      const csv = parse(formattedCsvData, {\r\n        fields: headers,\r\n        quote: '\"',\r\n        delimiter: \",\",\r\n      });\r\n      \r\n      const utf8Bom = \"\\ufeff\"; // ‚úÖ BOMÔºàByte Order MarkÔºâ„ÇíËøΩÂä†\r\n      fileBuffer = Buffer.from(utf8Bom + csv, \"utf-8\"); // ‚úÖ BOM‰ªò„Åç„Åß„Éê„ÉÉ„Éï„Ç°„Å´Â§âÊèõ\r\n      contentType = \"text/csv; charset=utf-8\"; // ‚úÖ Content-Type „Åß„Ç®„É≥„Ç≥„Éº„Éá„Ç£„É≥„Ç∞ÊåáÂÆö\r\n      fileExtension = \"csv\";\r\n    } else {\r\n      // ‚úÖ Excel ÂΩ¢Âºè„Åß„Ç®„ÇØ„Çπ„Éù„Éº„Éà\r\n      const workbook = new ExcelJS.Workbook();\r\n      const worksheet = workbook.addWorksheet(\"Exported Data\");\r\n\r\n      worksheet.addRow(headers);\r\n      filteredData.forEach(row => worksheet.addRow(row));\r\n\r\n      fileBuffer = await workbook.xlsx.writeBuffer();\r\n      contentType = \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\";\r\n      fileExtension = \"xlsx\";\r\n    }\r\n\r\n    console.log(\"üìÇ „Éï„Ç°„Ç§„É´ÁîüÊàêÂÆå‰∫Ü: export.\" + fileExtension);\r\n\r\n    return new Response(fileBuffer, {\r\n      headers: {\r\n        \"Content-Type\": contentType,\r\n        \"Content-Disposition\": `attachment; filename=\"export_${startDate}_${endDate}.${fileExtension}\"`,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"‚ùå „Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„Éº:\", error);\r\n    return NextResponse.json({ \r\n      error: (error as Error).message, \r\n      stack: (error as Error).stack\r\n    }, { status: 500 });\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 415, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}}]
}